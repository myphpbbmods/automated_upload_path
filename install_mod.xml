<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<?xml-stylesheet type="text/xsl" href="modx.prosilver.en.xsl"?>
<!--NOTICE: Please open this file in your web browser. If presented with a security warning, you may safely tell it to allow the blocked content.-->
<!--For security purposes, please check: http://www.phpbb.com/mods/ for the latest version of this MOD.\nAlthough MODs are checked before being allowed in the MODs Database there is no guarantee that there are no security problems within the MOD.\nNo support will be given for MODs not found within the MODs Database which can be found at http://www.phpbb.com/mods/-->
<mod xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.phpbb.com/mods/xml/modx-1.2.5.xsd">
	<header>
		<meta name="generator" content="MODX file generated with PP MODX Creator by tumba25 (online version)"/>
		<meta name="generator" content="MODX file generated by MODX Generator by tumba25"/>
		<license><![CDATA[http://opensource.org/licenses/gpl-license.php GNU General Public License v2]]></license>
		<title lang="en"><![CDATA[[RC1] Automated Upload Path]]></title>
		<description lang="en"><![CDATA[This mod enables you to distribute all uploaded files in several automatically created and chosen directories within the dirtectory definded with the ACP under (config) upload_path.

If you alter the upload folder within the ACP you are still able to download files you uploaded before installing this mod. Meaning you don't have to move files via FTP into the new folder you have chosen as upload path (via board settings).]]></description>
		<author-group>
			<author>
				<realname><![CDATA[Miriam]]></realname>
				<username><![CDATA[Miriam]]></username>
				<homepage><![CDATA[http://mymods.bplaced.net/]]></homepage>
				<email><![CDATA[myphpbbmods@gmail.com]]></email>
			</author>
		</author-group>
		<mod-version>1.0</mod-version>
		<installation>
			<level>easy</level>
			<time>300</time>
			<target-version>3.0.11</target-version>
		</installation>
	</header>
	<action-group>
		<sql><![CDATA[ALTER TABLE `phpbb_attachments` ADD `folder_name` VARCHAR( 255 ) CHARACTER SET utf8 COLLATE utf8_bin NULL DEFAULT NULL]]></sql>
		<sql><![CDATA[UPDATE phpbb_attachments SET folder_name = (SELECT config_value FROM phpbb_config WHERE config_name = 'upload_path') WHERE folder_name IS NULL]]></sql>
		<open src="download/file.php">
			<edit>
				<find><![CDATA[$sql = 'SELECT attach_id, is_orphan, in_message, post_msg_id, extension, physical_filename, real_filename, mimetype, filetime]]></find>
				<inline-edit>
					<inline-find><![CDATA[$sql = 'SELECT attach_id, is_orphan, in_message, post_msg_id, extension, physical_filename, real_filename, mimetype, filetime]]></inline-find>
					<inline-action type="after-add"><![CDATA[, folder_name]]></inline-action>
				</inline-edit>
			</edit>
			<edit>
				<find><![CDATA[	$filename = $phpbb_root_path . $upload_dir . '/' . $attachment['physical_filename'];]]></find>
				<inline-edit>
					<inline-find><![CDATA[$filename]]></inline-find>
					<inline-action type="replace-with"><![CDATA[$upload_dir]]></inline-action>
				</inline-edit>
				<inline-edit>
					<inline-find><![CDATA[ = ]]></inline-find>
					<inline-find><![CDATA[$phpbb_root_path]]></inline-find>
					<inline-action type="replace-with"><![CDATA[(empty($attachment['folder_name']))]]></inline-action>
				</inline-edit>
				<inline-edit>
					<inline-find><![CDATA[.]]></inline-find>
					<inline-action type="replace-with"><![CDATA[?]]></inline-action>
				</inline-edit>
				<inline-edit>
					<inline-find><![CDATA[ $upload_dir . '/' ]]></inline-find>
					<inline-find><![CDATA[.]]></inline-find>
					<inline-action type="replace-with"><![CDATA[:]]></inline-action>
				</inline-edit>
				<inline-edit>
					<inline-find><![CDATA[ $attachment[']]></inline-find>
					<inline-find><![CDATA[physical_filename]]></inline-find>
					<inline-action type="replace-with"><![CDATA[folder_name]]></inline-action>
				</inline-edit>
				<action type="after-add"><![CDATA[	$filename = $phpbb_root_path . $attachment['folder_name'] . '/' . $attachment['physical_filename'];]]></action>
			</edit>
		</open>
		<open src="includes/message_parser.php">
			<edit>
				<find><![CDATA[		$error = array();]]></find>
				<action type="after-add"><![CDATA[		$folder_name = (string)date('Y/W'); // set date based foldername at your descretion
		if (!empty($config['upload_path']) AND $config['upload_path'] !== '/')
		{
			// delete trailing slashes if applied with $config['upload_path']
			if (substr($config['upload_path'], -1, 1) == '/')
			{
				$config['upload_path'] = substr($config['upload_path'], 0, -1);
			}
		}
		// create the full path from forum-root for "folder_name" entry in attachments table
		$folder_name = (!empty($config['upload_path'])) ? $config['upload_path'] . '/' . $folder_name : $folder_name;
		// build the new path
		$config['upload_path'] = $folder_name;
		//create directory if necessary
		if (!is_dir($config['upload_path']))
		{
			if (!@mkdir($config['upload_path'], 0777, true))
			{
				trigger_error('NO_WRITE_UPLOAD', E_USER_ERROR);
			}
		}]]></action>
			</edit>
			<edit>
				<find><![CDATA[						'poster_id'			=> $user->data['user_id'],]]></find>
				<action type="after-add"><![CDATA[						'folder_name'		=> $folder,]]></action>
			</edit>
			<edit>
				<find><![CDATA[						'attach_comment'=> $this->filename_data['filecomment'],]]></find>
				<action type="after-add"><![CDATA[						'folder_name'	=> $folder_name,]]></action>
			</edit>
			<edit>
				<find><![CDATA[						$sql = 'SELECT attach_id, physical_filename, thumbnail]]></find>
				<inline-edit>
					<inline-find><![CDATA[						$sql = 'SELECT attach_id, physical_filename, thumbnail]]></inline-find>
					<inline-action type="after-add"><![CDATA[, folder_name]]></inline-action>
				</inline-edit>
			</edit>
			<edit>
				<find><![CDATA[							'poster_id'			=> $user->data['user_id'],]]></find>
				<action type="after-add"><![CDATA[							'folder_name'		=> $folder_name,]]></action>
			</edit>
			<edit>
				<find><![CDATA[							'attach_comment'=> $this->filename_data['filecomment'],]]></find>
				<action type="after-add"><![CDATA[							'folder_name'	=> $folder_name,]]></action>
			</edit>
			<edit>
				<find><![CDATA[			$sql = 'SELECT attach_id, is_orphan, real_filename, attach_comment]]></find>
				<inline-edit>
					<inline-find><![CDATA[			$sql = 'SELECT attach_id, is_orphan, real_filename, attach_comment]]></inline-find>
					<inline-action type="after-add"><![CDATA[, folder_name]]></inline-action>
				</inline-edit>
			</edit>
			<edit>
				<find><![CDATA[			$sql = 'SELECT attach_id, is_orphan, real_filename, attach_comment]]></find>
				<inline-edit>
					<inline-find><![CDATA[			$sql = 'SELECT attach_id, is_orphan, real_filename, attach_comment]]></inline-find>
					<inline-action type="after-add"><![CDATA[, folder_name]]></inline-action>
				</inline-edit>
			</edit>
		</open>
		<diy-instructions lang="en"><![CDATA[Deinstall former versions of this mod before installing RC1.

If you altered the attachment table adding the column named "folder_name" with installing a former version of this mod you might want to force install with AutoMod.]]></diy-instructions>
	</action-group>
</mod>
